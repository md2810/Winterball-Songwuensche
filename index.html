<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Suche</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            overflow: hidden; /* Verhindert Scrollen */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .song-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Scrollen innerhalb der Liste erlauben */
            height: calc(90vh - 80px); /* H√∂he anpassen */
        }
        .song-item, .not-found-item {
            background-color: #1f1f1f;
            border-radius: 16px; /* St√§rkere Abrundung */
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center; /* Vertikale Ausrichtung */
            justify-content: flex-start; /* Links ausrichten */
        }
        .cover {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 15px;
        }
        .hidden {
            display: none;
        }
        .not-found-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #1f1f1f; /* gleiche Farbe wie die Panels */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .not-found-button .material-icons {
            color: #ff9800; /* Dunkelorange */
        }
        .popover {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100vw; /* Breite auf 100% des Sichtbereichs */
            height: 90%;
            background: rgba(31, 31, 31, 0.9);
            display: none; /* Initially hidden */
            border-top-left-radius: 24px; /* St√§rkere Abrundung */
            border-top-right-radius: 24px; /* St√§rkere Abrundung */
            backdrop-filter: blur(5px); /* Blur hinter dem Popover */
            z-index: 1000;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        }
        .popover-content {
            max-height: calc(80% - 40px); /* H√∂he anpassen, um Platz f√ºr den Schlie√üen-Button zu schaffen */
            overflow-y: auto; /* Allow scrolling */
            width: 100%; /* Breite auf 100% setzen */
        }
        .song-info {
            display: flex;
            flex-direction: column; /* Vertikale Anordnung f√ºr Titel und K√ºnstler */
            margin-left: 5px; /* Kleinere Abst√§nde zwischen Titel und K√ºnstler */
        }
        .link {
            margin-left: auto; /* Links-Symbol nach rechts */
        }
        .song-info strong {
            margin-bottom: 2px; /* Geringerer Abstand zwischen Titel und K√ºnstler */
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ff9800; /* Dunkelorange */
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            font-size: 20px; /* Gr√∂√üere Schrift f√ºr das X */
            z-index: 1001; /* Sicherstellen, dass der Button √ºber dem Popover ist */
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Song Suche</h1>
</div>
<div class="song-list" id="songList"></div>
<div class="popover" id="notFoundPopover">
    <button class="close-button" id="closePopover">‚úñ</button>
    <div class="popover-content" id="notFoundList"></div>
</div>
<button class="not-found-button" id="notFoundButton">
    <span class="material-icons">warning</span>
</button>

<script>
    const SHEET_ID = '1v_l6HE6zcx22ADXNJHbcn3FwJ95I3TcaH9lhN2qkNVY';
    const GOOGLE_API_KEY = 'AIzaSyDMaLLPOkf6U-bZn2tni5oYT3JOE6gLt4g';
    const SPOTIFY_CLIENT_ID = 'c6ac848d1a84407fac1ef488542331eb';
    const SPOTIFY_CLIENT_SECRET = 'd5206b845b2840ceb64de514f6e0549e';
    const notFoundSongs = [];

    async function fetchSongs() {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Songs!B:C?key=${GOOGLE_API_KEY}`);
        const data = await response.json();
        return data.values.slice(1); // Ignore the first row
    }

    async function fetchSpotifyToken() {
        const response = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'grant_type=client_credentials'
        });
        const data = await response.json();
        return data.access_token;
    }

    async function searchSpotify(songTitle, artist) {
        const token = await fetchSpotifyToken();
        const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(songTitle)}%20artist:${encodeURIComponent(artist)}&type=track`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const data = await response.json();
        return data.tracks.items[0]; // Returning the first found track
    }

    async function displaySongs() {
        const songs = await fetchSongs();
        const songList = document.getElementById('songList');
        for (let i = 0; i < songs.length; i++) { // Start from 0 to include all rows
            const [title, artist] = songs[i];
            const spotifyTrack = await searchSpotify(title, artist);

            const songItem = document.createElement('div');
            songItem.classList.add('song-item');
            if (spotifyTrack) {
                const { name, artists, album } = spotifyTrack;
                songItem.innerHTML = `
                    <img class="cover" src="${album.images[0].url}" alt="${name}">
                    <div class="song-info">
                        <strong>${name}</strong>
                        <span>${artists.map(a => a.name).join(', ')}</span>
                    </div>
                    <a class="link" href="https://open.spotify.com/track/${spotifyTrack.id}" target="_blank">üîó</a>
                `;
            } else {
                notFoundSongs.push({ title, artist });
                // Song wird nicht in der Hauptliste angezeigt
            }
            songList.appendChild(songItem);
        }
        displayNotFoundSongs();
    }

    function displayNotFoundSongs() {
        const notFoundList = document.getElementById('notFoundList');
        notFoundSongs.forEach(song => {
            const notFoundItem = document.createElement('div');
            notFoundItem.classList.add('not-found-item');
            notFoundItem.innerHTML = `
                <div class="song-item">
                    <img class="cover" src="https://via.placeholder.com/50" alt="${song.title}"> <!-- Placeholder Bild f√ºr nicht gefundene Songs -->
                    <div class="song-info">
                        <strong>${song.title}</strong> - ${song.artist}<br>
                        <a href="#">Manueller Link</a>
                    </div>
                </div>
            `;
            notFoundList.appendChild(notFoundItem);
        });
    }

    document.getElementById('notFoundButton').addEventListener('click', () => {
        const notFoundPopover = document.getElementById('notFoundPopover');
        notFoundPopover.style.display = 'flex'; // Show popover
    });

    document.getElementById('closePopover').addEventListener('click', () => {
        const notFoundPopover = document.getElementById('notFoundPopover');
        notFoundPopover.style.display = 'none'; // Hide popover
    });

    // Close popover when clicking outside of it
    window.addEventListener('click', (event) => {
        const notFoundPopover = document.getElementById('notFoundPopover');
        if (event.target === notFoundPopover) {
            notFoundPopover.style.display = 'none'; // Hide popover when clicking outside
        }
    });

    displaySongs();
</script>
</body>
</html>
